# BettaFish 系统流程图

## 系统整体流程

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                                 用户输入查询                                      │
│                            "分析XX事件的舆情走向"                                  │
└─────────────────────────────────┬───────────────────────────────────────────────┘
                                  │
                                  ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              app.py (Flask后端)                                  │
│                         接收请求，启动三个Engine线程                               │
└───────────┬─────────────────────┼─────────────────────┬─────────────────────────┘
            │                     │                     │
            ▼                     ▼                     ▼
┌───────────────────┐  ┌───────────────────┐  ┌───────────────────┐
│   InsightEngine   │  │   MediaEngine     │  │   QueryEngine     │
│   (本地数据库)     │  │   (Bocha/Anspire) │  │   (Tavily API)    │
└─────────┬─────────┘  └─────────┬─────────┘  └─────────┬─────────┘
          │                      │                      │
          └──────────────────────┼──────────────────────┘
                                 │
                                 ▼
        ┌────────────────────────────────────────────────────┐
        │              各Engine内部处理流程 (相同)             │
        │  ┌──────────────────────────────────────────────┐  │
        │  │  Step 1: ReportStructureNode                 │  │
        │  │  生成报告结构 (3-5个段落大纲)                   │  │
        │  └──────────────────────┬───────────────────────┘  │
        │                         ▼                          │
        │  ┌──────────────────────────────────────────────┐  │
        │  │  Step 2: 遍历每个段落                         │  │
        │  │  ┌────────────────────────────────────────┐  │  │
        │  │  │ 2.1 FirstSearchNode → 生成搜索关键词    │  │  │
        │  │  │     ↓                                  │  │  │
        │  │  │ 2.2 执行搜索 (调用对应API)              │  │  │
        │  │  │     ↓                                  │  │  │
        │  │  │ 2.3 FirstSummaryNode → 初始总结        │  │  │
        │  │  │     ↓                                  │  │  │
        │  │  │ ╔════════════════════════════════════╗ │  │  │
        │  │  │ ║  反思循环 (MAX_REFLECTIONS=3次)    ║ │  │  │
        │  │  │ ║  ┌──────────────────────────────┐ ║ │  │  │
        │  │  │ ║  │ ReflectionNode → 新搜索词    │ ║ │  │  │
        │  │  │ ║  │        ↓                     │ ║ │  │  │
        │  │  │ ║  │ 执行补充搜索                 │ ║ │  │  │
        │  │  │ ║  │        ↓                     │ ║ │  │  │
        │  │  │ ║  │ ReflectionSummaryNode        │ ║ │  │  │
        │  │  │ ║  │ → 整合新旧信息               │ ║ │  │  │
        │  │  │ ║  └──────────────────────────────┘ ║ │  │  │
        │  │  │ ╚════════════════════════════════════╝ │  │  │
        │  │  └────────────────────────────────────────┘  │  │
        │  └──────────────────────┬───────────────────────┘  │
        │                         ▼                          │
        │  ┌──────────────────────────────────────────────┐  │
        │  │  Step 3: ReportFormattingNode                │  │
        │  │  整合所有段落 → 生成最终报告                   │  │
        │  └──────────────────────────────────────────────┘  │
        └────────────────────────┬───────────────────────────┘
                                 │
                                 ▼ (写入日志)
        ┌────────────────────────────────────────────────────┐
        │                   ForumEngine                       │
        │  ┌──────────────────────────────────────────────┐  │
        │  │  LogMonitor 监控三个日志文件:                  │  │
        │  │  - insight.log                               │  │
        │  │  - media.log                                 │  │
        │  │  - query.log                                 │  │
        │  └──────────────────────┬───────────────────────┘  │
        │                         ▼                          │
        │  ┌──────────────────────────────────────────────┐  │
        │  │  每5次Agent发言 → ForumHost生成主持人总结     │  │
        │  │  - 综合各引擎观点                             │  │
        │  │  - 识别共识与分歧                             │  │
        │  │  - 提供方向建议                               │  │
        │  └──────────────────────────────────────────────┘  │
        └────────────────────────┬───────────────────────────┘
                                 │
                                 ▼
        ┌────────────────────────────────────────────────────┐
        │                  ReportEngine                       │
        │  ┌──────────────────────────────────────────────┐  │
        │  │  整合三个Engine的报告 + Forum讨论结果          │  │
        │  │  生成最终综合舆情分析报告                      │  │
        │  └──────────────────────────────────────────────┘  │
        └────────────────────────┬───────────────────────────┘
                                 │
                                 ▼
        ┌────────────────────────────────────────────────────┐
        │                    输出结果                         │
        │  - Markdown报告 (reports/目录)                     │
        │  - 前端实时展示 (WebSocket推送)                     │
        │  - 状态JSON (可选保存)                              │
        └────────────────────────────────────────────────────┘
```

## 关键词优化流程 (InsightEngine特有)

```
┌─────────────────┐
│   原始查询       │
│ "特朗普关税政策" │
└────────┬────────┘
         │
         ▼
┌─────────────────────────────────────────┐
│        KeywordOptimizer (LLM)           │
│  将1个查询扩展为10-20个网络化关键词       │
└────────┬────────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────────┐
│  扩展后的关键词列表:                      │
│  - "特朗普加征关税"                       │
│  - "中美贸易战最新"                       │
│  - "关税政策影响"                         │
│  - "特朗普经济政策"                       │
│  - ... (共10-20个)                       │
└────────┬────────────────────────────────┘
         │
         ▼ (每个关键词独立搜索)
┌─────────────────────────────────────────┐
│  并行执行多次数据库查询                   │
│  结果汇总去重 → 进入总结流程              │
└─────────────────────────────────────────┘
```

## 数据流向简图

```
用户查询
    │
    ├──→ InsightEngine ──→ 本地MySQL (已爬取的微博/小红书数据)
    │         │
    ├──→ MediaEngine ────→ Bocha/Anspire API (实时网络搜索)
    │         │
    └──→ QueryEngine ────→ Tavily API (实时新闻搜索)
              │
              ▼
         ForumEngine (日志监控 + 讨论协调)
              │
              ▼
         ReportEngine (最终报告生成)
              │
              ▼
         前端展示 + 文件保存
```

## 三大搜索引擎对比

| 特性 | InsightEngine | MediaEngine | QueryEngine |
|------|---------------|-------------|-------------|
| 数据源 | 本地MySQL数据库 | Bocha/Anspire API | Tavily API |
| 数据类型 | 已爬取的社交媒体 | 实时网络搜索 | 实时新闻搜索 |
| 关键词优化 | 有 (10-20个) | 无 | 无 |
| 搜索工具数 | 6种 | 5种 | 6种 |
| 反思轮次 | 3次 | 3次 | 3次 |

## 核心设计理念

1. **多源异构**: 三个引擎分别负责不同数据源，互为补充
2. **反思迭代**: 每个段落经过多轮搜索-总结-反思循环，逐步深化
3. **协调讨论**: ForumEngine作为主持人协调各引擎观点
4. **关键词扩展**: LLM将用户查询扩展为网络化表达，提高搜索召回率
